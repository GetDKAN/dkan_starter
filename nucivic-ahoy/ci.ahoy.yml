ahoyapi: v1
version: 0.0.0
commands:
  setup:
    usage: switchs between ci setups
    cmd: |
      name=$(ahoy site name)

      if [ "$name" = 'datastarter' ]; then
        echo "Site name datastarter. Going with DKAN base install"
        ahoy site reinstall
      else
        echo "Site name set. Pulling database from s3 bucket"
        ahoy site s3-setup
        ahoy site asset-download
        ahoy site files-link
        ahoy site files-fix-permissions
        ahoy drush sql-cli < backups/sanitized.sql
      fi

  deploy:
    usage: deploys within a ci setup
    cmd: |
      echo "DELETE FROM search_api_index where server = 'dkan_acquia_solr';" > delete.sql
      echo "DELETE FROM search_api_index where server = 'local_solr_server';" >> delete.sql
      echo "DELETE FROM search_api_server where machine_name = 'dkan_acquia_solr';" >> delete.sql
      echo "DELETE FROM search_api_server where machine_name = 'local_solr_server';" >> delete.sql
      echo "DELETE FROM search_api_index where server IS NULL;" >> delete.sql
      ahoy drush sqlc < delete.sql
      rm delete.sql
      name=$(ahoy site name)
      ahoy site truncate-watchdog
      ahoy cmd-proxy bash hooks/common/post-code-deploy/drush-env-switch.sh $name local
      ahoy drush user-password 1 --password='SuperSecret!321'
