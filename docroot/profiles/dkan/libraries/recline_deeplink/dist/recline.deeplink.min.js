/*! recline.deeplink v0.1 */
this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},function(a,b){"use strict";b.Router=function(a){var c,d=this,e={},f=new b.Parser,g=DeepDiff.noConflict(),h=_.clone(_.omit(a.state.attributes,"dataset"));d.updateState=function(b){var c=d.transform(b,d.toState);e=c||{},c&&(c=_.extend(a.state.attributes,c),a.model.queryState.set(c.query),a.updateNav(c.currentView),_.each(a.pageViews,function(b,d){var e="view-"+b.id,f=a.pageViews[d];f.view.state.set(c[e]),"function"==typeof f.view.redraw&&"graph"===f.id?setTimeout(f.view.redraw,0):"grid"===f.id&&f.view.render()}))},d.transform=function(a,b){var c;try{c=b(a)}catch(d){console.log(d),c=null}return c},d.toState=function(a){var b=f.inflate(decodeURI(a));return JSON.parse(b)},d.toParams=function(a){var b=JSON.stringify(_.omit(a.attributes,"dataset"));return f.compress(b)},d.onStateChange=function(){var b=g.diff(h,_.omit(a.state.attributes,"dataset")),f={};_.each(b,function(a){"E"===a.kind?d.createNestedObject(f,a.path,a.rhs):"A"===a.kind&&d.createNestedObject(f,a.path,a)}),e=_.extend(e,f);var i=new recline.Model.ObjectState;i.attributes=e,c.navigate(d.transform(i,d.toParams)),d.updateControls()},d.createNestedObject=function(a,b,c){for(var d=_.clone(b),e=3===arguments.length?d.pop():!1,f=0;f<d.length;f++)a=a[d[f]]=a[d[f]]||{};return!e||_.isArray(c)||_.isObject(c)||(a=a[e]=c),_.isObject(c)&&"A"===c.kind&&(_.isUndefined(a[e])&&(a[e]=[]),"N"==c.item.kind&&(a=a[e][c.index]=c.item.rhs),"D"==c.item.kind&&(a[e].splice(c.index,c.item.rhs),a=a[e])),a},d.updateControls=function(){var b=a.state.get("currentView");if(a.pager.render(),"graph"===b||"map"===b){var c=d.getCurrentViewIndex(),e={graph:"editor",map:"menu"},f=e[b],g=a.pageViews[c].view[f],h=d.getCurrentView().view.state;g.state.set(h.attributes),g.render()}},d.getCurrentView=function(){var b=a.state.get("currentView");return _.findWhere(a.pageViews,{id:b})},d.getCurrentViewIndex=function(){var b,c=a.state.get("currentView");return _.each(a.pageViews,function(a,d){a.id===c&&(b=d)}),b},d.initialize=function(){var b=Backbone.Router.extend({routes:{"*state":"defaultRoute"},defaultRoute:function(a){d.updateState(a)}});c=new b,a.listenTo(a.state,"all",d.onStateChange),a.model.bind("all",d.onStateChange),Backbone.history.start()},d.initialize()},b.Parser=function(){var a=this;a.compress=function(b){return a.escapeStrings(b)},a.inflate=function(b){return a.parseStrings(b)},a.escapeStrings=function(a){return a=a.replace(/"([a-zA-Z-_.]+)"\s?:/g,"$1:"),a=a.replace(/\x20(?![^"]*("[^"]*"[^"]*)*$)/g,"_"),a.replace(/"([a-zA-Z-#_.-]+)?"/g,"!$1")},a.parseStrings=function(a){return a=a.replace(/([a-zA-Z-_.]+)\s?:/g,'"$1":'),a=a.replace(/![a-zA-Z0-9_. -]+/g,function(a){return a.replace(/_/g," ")}),a.replace(new RegExp("!([a-zA-Z-# .-]+)?","g"),'"$1"')}}}(jQuery,this.recline.DeepLink);