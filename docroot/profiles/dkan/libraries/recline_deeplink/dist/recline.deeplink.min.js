/*! recline.deeplink 2014-11-03 */
this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},function(a,b){"use strict";b.Router=function(a){var b,c=this,d={};c.updateState=function(b){var e=c.parmsToState(b);d=e||{},e&&(e=_.extend(a.state.attributes,e),a.model.queryState.set(e.query),a.updateNav(e.currentView),_.each(a.pageViews,function(b,c){var d="view-"+b.id,f=a.pageViews[c];f.view.state.set(e[d]),"function"==typeof f.view.redraw&&"graph"===f.id&&setTimeout(f.view.redraw,0)}))},c.parmsToState=function(a){var b;try{b=JSON.parse(decodeURI(a))}catch(c){b=null}return b},c.stateToParams=function(a){var b;try{b=encodeURI(JSON.stringify(_.omit(a.attributes,"dataset")))}catch(c){b=null}return b},c.replaceAll=function(a,b,c){return c.replace(new RegExp(a,"g"),b)},c.onStateChange=function(){var e=new recline.Model.ObjectState;d=c.saveChanges(a.state.changed,d),e.attributes=d,b.navigate(c.stateToParams(e)),c.updateControls()},c.saveChanges=function(a,b){for(var c in a)b[c]=a[c];return b},c.updateControls=function(){var b=a.state.get("currentView");if("graph"===b||"map"===b){var d=c.getCurrentViewIndex(),e={graph:"editor",map:"menu"},f=e[b],g=a.pageViews[d].view[f],h=c.getCurrentView().view.state;g.state.set(h.attributes),g.render()}},c.getCurrentView=function(){var b=a.state.get("currentView");return _.findWhere(a.pageViews,{id:b})},c.getCurrentViewIndex=function(){var b,c=a.state.get("currentView");return _.each(a.pageViews,function(a,d){a.id===c&&(b=d)}),b},c.initialize=function(){var d=Backbone.Router.extend({routes:{"*state":"defaultRoute"},defaultRoute:function(a){c.updateState(a)}});b=new d,a.listenTo(a.state,"all",c.onStateChange),a.model.bind("all",c.onStateChange),Backbone.history.start()},c.initialize()}}(jQuery,this.recline.DeepLink);